# Async Hooks Investigation - Claude Code Integration

**Date**: 2026-01-25
**Investigator**: Research Agent
**Status**: ✅ Complete
**Classification**: Informational (Background Research)

## Executive Summary

Investigated the Kuzu Memory hook deployment system to understand current architecture and requirements for adding async hook support. Found comprehensive infrastructure already in place with migration system ready for async flag deployment.

**Key Findings:**
- ✅ Hook configuration location identified: `.claude/settings.local.json`
- ✅ Migration system exists and is mature (v1.7.0 example available)
- ✅ Version management infrastructure complete
- ❌ **No async flag currently set** in hook configurations
- ✅ Infrastructure ready for async hook migration

---

## 1. Hook Configuration System

### Current Hook Configuration Location

**Primary Configuration File:**
`.claude/settings.local.json` (project-level)

**Configuration Structure:**
```json
{
  "_comment": "Generated by KuzuMemory v{version} - Claude Code hooks configuration",
  "hooks": {
    "SessionStart": [
      {
        "matcher": "*",
        "hooks": [
          {
            "type": "command",
            "command": "/path/to/kuzu-memory hooks session-start"
          }
        ]
      }
    ],
    "UserPromptSubmit": [
      {
        "matcher": "*",
        "hooks": [
          {
            "type": "command",
            "command": "/path/to/kuzu-memory hooks enhance"
          }
        ]
      }
    ],
    "PostToolUse": [
      {
        "matcher": "*",
        "hooks": [
          {
            "type": "command",
            "command": "/path/to/kuzu-memory hooks learn"
          }
        ]
      }
    ]
  }
}
```

**Key Code Location:**
`src/kuzu_memory/installers/claude_hooks.py:481-544`
Method: `_create_claude_code_hooks_config()`

### Valid Claude Code Hook Events

**Defined in:** `src/kuzu_memory/installers/claude_hooks.py:29-41`

```python
VALID_CLAUDE_CODE_EVENTS = {
    "UserPromptSubmit",  # Fires when user submits a prompt
    "PreToolUse",        # Fires before a tool is used
    "PostToolUse",       # Fires after a tool is used
    "Stop",              # Fires when Claude finishes responding
    "SubagentStop",      # Fires when a subagent stops
    "Notification",      # Fires on notifications
    "SessionStart",      # Fires at session start
    "SessionEnd",        # Fires at session end
    "PreCompact",        # Fires before compaction
}
```

### Async Flag Status

**Current State:** ❌ **NO ASYNC FLAG PRESENT**

**Evidence:**
- Grep search for `"async":\s*(true|false)` found only one reference in documentation
- Hook configuration in `_create_claude_code_hooks_config()` does NOT include async flag
- Current hook structure does not have async field

**Where async flag should be added:**
```json
{
  "type": "command",
  "command": "/path/to/kuzu-memory hooks learn",
  "async": true  // ← THIS FIELD NEEDS TO BE ADDED
}
```

---

## 2. Migration System Infrastructure

### Migration Manager

**Location:** `src/kuzu_memory/migrations/manager.py`

**Key Features:**
- ✅ State persistence in `.kuzu-memory/migration_state.json`
- ✅ Version tracking and migration history
- ✅ Automatic migration discovery
- ✅ Rollback support with automatic backups
- ✅ Dry-run mode for testing
- ✅ Priority-based execution (0-999, lower runs first)

**Core Classes:**
```python
MigrationManager       # Orchestrates migrations
MigrationState         # Persistent state tracking
MigrationHistory       # Historical migration records
```

**State File Example:**
```json
{
  "last_version": "1.7.0",
  "history": [
    {
      "name": "bash_hooks_v1.7.0",
      "version": "1.7.0",
      "migration_type": "hooks",
      "timestamp": "2025-11-23T10:30:00",
      "success": true,
      "message": "Migrated 3 hook(s) to bash",
      "changes": ["Migrated learn hook", "Migrated session-start hook"]
    }
  ]
}
```

### Migration Base Classes

**Location:** `src/kuzu_memory/migrations/base.py`

**Available Base Classes:**
```python
Migration              # Abstract base (requires implementation)
ConfigMigration        # For config file migrations
SchemaMigration        # For database schema changes
HooksMigration         # ← RELEVANT FOR ASYNC HOOKS
CleanupMigration       # For cleanup operations
```

**HooksMigration Methods:**
- `get_hooks_config_paths()` - Returns list of settings.json paths
- `check_applicable()` - Returns True if any hooks config exists

**Key Methods to Implement:**
```python
def description(self) -> str:
    """Human-readable description"""

def check_applicable(self) -> bool:
    """Check if migration should run"""

def migrate(self) -> MigrationResult:
    """Perform the migration"""

def rollback(self) -> bool:
    """Rollback if migration fails"""
```

### Example Migration: v1.7.0 Bash Hooks

**Location:** `src/kuzu_memory/migrations/v1_7_0_bash_hooks.py`

**Migration Pattern:**
1. **Check Applicability**: Scan settings files for old hook format
2. **Backup**: Create `.json.bak` backup before modifying
3. **Transform**: Update hook configuration in-place
4. **Validate**: Ensure changes are correct
5. **Report**: Return MigrationResult with changes list

**Key Code Snippets:**
```python
class BashHooksMigration(HooksMigration):
    name = "bash_hooks_v1.7.0"
    from_version = "1.7.0"
    to_version = "999.0.0"
    priority = 100

    def _migrate_settings(self, settings_path: Path) -> list[str]:
        settings = json.loads(settings_path.read_text())
        hooks = settings.get("hooks", {})

        # Backup before modifying
        backup_path = settings_path.with_suffix(".json.bak")
        shutil.copy(settings_path, backup_path)

        # Transform hooks (example)
        for event, hook_list in hooks.items():
            for hook in hook_list:
                # Modify hook configuration here
                pass

        # Write updated config
        settings_path.write_text(json.dumps(settings, indent=2))
```

---

## 3. Version Management System

### Current Version

**Version:** `1.6.32`
**Location:** `/VERSION` file at project root

### Version Management Script

**Location:** `scripts/version.py`

**Key Features:**
- ✅ Semantic versioning (major.minor.patch)
- ✅ Automatic pyproject.toml updates
- ✅ Automatic `__version__.py` updates
- ✅ CHANGELOG.md generation
- ✅ Git tagging support
- ✅ Build info generation
- ✅ Towncrier fragment integration

**Usage:**
```bash
# Bump version
./scripts/version.py bump --type patch  # 1.6.32 → 1.6.33
./scripts/version.py bump --type minor  # 1.6.32 → 1.7.0
./scripts/version.py bump --type major  # 1.6.32 → 2.0.0

# Preview changelog
./scripts/version.py preview-changelog

# Build changelog from fragments
./scripts/version.py build-changelog --version 1.7.0 --yes

# Create git tag
./scripts/version.py tag
```

**Version Synchronization:**
Automatically updates:
- `/VERSION`
- `pyproject.toml` (version field)
- `src/kuzu_memory/__version__.py` (__version__ variable)

---

## 4. Hook Deployment Code

### Claude Hooks Installer

**Location:** `src/kuzu_memory/installers/claude_hooks.py`

**Key Methods:**

**Hook Configuration Creation:**
- `_create_claude_code_hooks_config()` (lines 481-544)
  - Creates hooks configuration dictionary
  - **Does NOT currently include async flag**
  - Returns config for settings.local.json

**Hook Validation:**
- `_validate_hook_events()` (lines 461-479)
  - Validates event names against VALID_CLAUDE_CODE_EVENTS
  - Logs warnings for invalid events

**Hook Testing:**
- `_test_hook_commands()` (lines 1788-1832)
  - Tests hook execution with sample inputs
  - Validates hooks return successfully
  - Times out after 5 seconds

**Hook Auto-Repair:**
- `_repair_hooks_config()` (lines 1646-1701)
  - Fixes command paths
  - Migrates legacy event names
  - Fixes legacy command syntax

### Hook Installation Flow

**Installation Steps:**
1. Check prerequisites (kuzu-memory CLI installed)
2. Migrate broken MCP configs (if any)
3. Create/update CLAUDE.md
4. Create/update `.claude-mpm/config.json`
5. **Create/update `.claude/settings.local.json`** ← Where hooks are configured
6. Clean up legacy files
7. Configure MCP server in `~/.claude.json`
8. Initialize database if needed
9. **Test installation** (includes hook validation and repair)

**Key Code Path:**
```
install() →
  _create_claude_code_hooks_config() →
    Settings merged with existing config →
      _validate_hook_events() →
        Written to settings.local.json
```

---

## 5. Implementation Roadmap: Adding Async Hook Support

### Required Changes

**1. Update Hook Configuration Generation**

**File:** `src/kuzu_memory/installers/claude_hooks.py:481-544`

**Change:**
```python
def _create_claude_code_hooks_config(self) -> dict[str, Any]:
    config = {
        "_comment": f"Generated by KuzuMemory v{pkg_version}",
        "hooks": {
            "SessionStart": [
                {
                    "matcher": "*",
                    "hooks": [
                        {
                            "type": "command",
                            "command": f"{kuzu_memory_path} hooks session-start",
                            "async": True  # ← ADD THIS
                        }
                    ],
                }
            ],
            "PostToolUse": [
                {
                    "matcher": "*",
                    "hooks": [
                        {
                            "type": "command",
                            "command": f"{kuzu_memory_path} hooks learn",
                            "async": True  # ← ADD THIS
                        }
                    ],
                }
            ],
            # UserPromptSubmit should NOT be async (needs sync response)
            "UserPromptSubmit": [
                {
                    "matcher": "*",
                    "hooks": [
                        {
                            "type": "command",
                            "command": f"{kuzu_memory_path} hooks enhance",
                            # NO async flag - this must be synchronous
                        }
                    ],
                }
            ],
        },
    }
    return config
```

**Rationale:**
- `SessionStart`: Async ✅ (initialization can happen in background)
- `PostToolUse`: Async ✅ (learning doesn't need to block user)
- `UserPromptSubmit`: Sync ❌ (must enhance prompt before proceeding)

**2. Create Migration for Existing Installations**

**File:** `src/kuzu_memory/migrations/v1_7_0_async_hooks.py` (NEW FILE)

**Structure:**
```python
"""Migration to add async flags to hooks for v1.7.0."""

from __future__ import annotations
import json
import logging
from pathlib import Path
from .base import HooksMigration, MigrationResult

logger = logging.getLogger(__name__)


class AsyncHooksMigration(HooksMigration):
    """Add async flags to appropriate hooks for better performance."""

    name = "async_hooks_v1.7.0"
    from_version = "1.7.0"
    to_version = "999.0.0"
    priority = 110  # Run after bash_hooks (priority 100)

    def description(self) -> str:
        return "Add async flags to non-blocking hooks (SessionStart, PostToolUse)"

    def check_applicable(self) -> bool:
        """Check if any settings files have hooks without async flags."""
        for settings_path in self._get_settings_paths():
            if settings_path.exists():
                try:
                    settings = json.loads(settings_path.read_text())
                    hooks = settings.get("hooks", {})

                    # Check SessionStart and PostToolUse for missing async flags
                    for event in ["SessionStart", "PostToolUse"]:
                        if event in hooks:
                            for hook_group in hooks[event]:
                                for hook in hook_group.get("hooks", []):
                                    if "kuzu" in hook.get("command", ""):
                                        # Found kuzu hook without async flag
                                        if "async" not in hook:
                                            return True
                except Exception:
                    pass
        return False

    def migrate(self) -> MigrationResult:
        """Add async flags to appropriate hooks."""
        changes = []

        for settings_path in self._get_settings_paths():
            if settings_path.exists():
                result = self._migrate_settings(settings_path)
                if result:
                    changes.extend(result)

        if changes:
            return MigrationResult(
                success=True,
                message=f"Added async flags to {len(changes)} hook(s)",
                changes=changes,
            )
        else:
            return MigrationResult(
                success=True,
                message="No hooks needed async flag updates",
                changes=[],
            )

    def _get_settings_paths(self) -> list[Path]:
        """Get all possible settings.local.json paths."""
        return [
            Path.home() / ".claude" / "settings.local.json",
            Path.cwd() / ".claude" / "settings.local.json",
        ]

    def _migrate_settings(self, settings_path: Path) -> list[str]:
        """Add async flags to a single settings file."""
        changes = []

        try:
            settings = json.loads(settings_path.read_text())
            hooks = settings.get("hooks", {})

            # Events that should be async
            async_events = ["SessionStart", "PostToolUse"]

            for event in async_events:
                if event not in hooks:
                    continue

                for hook_group in hooks[event]:
                    for hook in hook_group.get("hooks", []):
                        command = hook.get("command", "")

                        # Only modify kuzu-memory hooks
                        if "kuzu" not in command.lower():
                            continue

                        # Add async flag if not present
                        if "async" not in hook:
                            hook["async"] = True
                            changes.append(
                                f"Added async=true to {event} hook in {settings_path.name}"
                            )
                            logger.info(f"Added async flag to {event} in {settings_path}")

            if changes:
                # Backup original
                backup_path = settings_path.with_suffix(".json.bak")
                import shutil
                shutil.copy(settings_path, backup_path)
                logger.info(f"Backed up settings to {backup_path}")

                # Write updated settings
                settings_path.write_text(json.dumps(settings, indent=2))

            return changes

        except Exception as e:
            logger.error(f"Failed to migrate {settings_path}: {e}")
            return []
```

**3. Bump Version**

**Command:**
```bash
./scripts/version.py bump --type minor  # 1.6.32 → 1.7.0
```

**Rationale:** Async hooks are a feature enhancement (not a breaking change), so minor version bump is appropriate.

**4. Test Migration**

**Testing Steps:**
```bash
# Create test environment
cd /tmp/test-kuzu-async
mkdir -p .claude

# Create mock settings.local.json without async flags
cat > .claude/settings.local.json <<EOF
{
  "hooks": {
    "SessionStart": [
      {
        "matcher": "*",
        "hooks": [
          {
            "type": "command",
            "command": "kuzu-memory hooks session-start"
          }
        ]
      }
    ],
    "PostToolUse": [
      {
        "matcher": "*",
        "hooks": [
          {
            "type": "command",
            "command": "kuzu-memory hooks learn"
          }
        ]
      }
    ]
  }
}
EOF

# Run migration (dry-run first)
kuzu-memory migrate --dry-run

# Run actual migration
kuzu-memory migrate

# Verify async flags were added
cat .claude/settings.local.json | jq '.hooks'
```

**5. Update Tests**

**Add test cases:**
- Test async flag present in new installations
- Test migration adds async flag to existing installations
- Test async flag NOT added to UserPromptSubmit (must remain sync)
- Test rollback removes async flags

**6. Update Documentation**

**Files to update:**
- `CHANGELOG.md` - Document async hooks feature
- `docs/user/HOOKS.md` - Explain async vs sync hooks
- `README.md` - Mention improved performance
- `docs/development/MIGRATION_GUIDE.md` - Document migration pattern

---

## 6. Technical Details

### Migration Discovery

**Auto-Discovery:** `src/kuzu_memory/migrations/__init__.py:37-75`

**Pattern:**
- Scans for modules starting with `v` (e.g., `v1_7_0_async_hooks.py`)
- Imports all `Migration` subclasses
- Excludes base classes only (not subclass implementations)
- Registers with MigrationManager

**Registration:**
```python
def get_migration_manager(project_root: Path | None = None) -> MigrationManager:
    manager = MigrationManager(project_root=project_root)
    for migration_cls in discover_migrations():
        manager.register(migration_cls)
    return manager
```

### Migration Execution Order

**Priority System:**
- Lower priority number = runs first (0-999)
- Same priority: sorted by `from_version`
- Example: bash_hooks (priority 100) runs before async_hooks (priority 110)

**Execution Flow:**
```
1. Load migration state from .kuzu-memory/migration_state.json
2. Get pending migrations (target_version >= from_version AND last_version < to_version)
3. Filter by applicability (check_applicable() returns True)
4. Sort by priority, then version
5. Execute each migration sequentially
6. Record results in history
7. Update last_version
8. Save state
```

### Migration State Persistence

**File:** `.kuzu-memory/migration_state.json`

**Schema:**
```json
{
  "last_version": "1.7.0",
  "history": [
    {
      "name": "migration_name",
      "version": "1.7.0",
      "migration_type": "hooks",
      "timestamp": "2026-01-25T14:30:00",
      "success": true,
      "message": "Migration completed",
      "changes": ["List of changes"]
    }
  ]
}
```

---

## 7. Risks and Considerations

### Compatibility Risks

**1. Old Claude Code Versions**
- **Risk:** Older Claude Code versions may not support async flag
- **Mitigation:** Version check before migration OR graceful degradation (Claude ignores unknown fields)
- **Action:** Test with multiple Claude Code versions

**2. User Customizations**
- **Risk:** Users may have customized hooks that migration breaks
- **Mitigation:** Backup before migration, only modify kuzu-memory hooks
- **Action:** Log warnings if non-kuzu hooks detected

**3. Rollback Failures**
- **Risk:** Migration rollback may fail if backup is corrupted
- **Mitigation:** Multiple backup strategies (timestamped backups)
- **Action:** Test rollback thoroughly

### Performance Considerations

**Benefits:**
- Async hooks don't block user interactions
- Faster perceived response time
- Better resource utilization

**Tradeoffs:**
- Learning happens asynchronously (slight delay before knowledge is captured)
- SessionStart initialization may not complete before first prompt

**Recommendation:** Document async behavior in user-facing docs

### Testing Requirements

**Required Tests:**
1. ✅ New installations have async flags
2. ✅ Migrations add async flags to existing installations
3. ✅ UserPromptSubmit remains synchronous
4. ✅ Rollback removes async flags
5. ✅ Multiple settings files handled correctly
6. ✅ Non-kuzu hooks are not modified
7. ✅ Migration is idempotent (safe to run multiple times)

---

## 8. Implementation Checklist

### Phase 1: Preparation
- [ ] Create feature branch: `feature/async-hooks-support`
- [ ] Bump version to 1.7.0: `./scripts/version.py bump --type minor`
- [ ] Create changelog fragment: `changelog.d/async-hooks.feature.md`

### Phase 2: Code Changes
- [ ] Update `_create_claude_code_hooks_config()` to add async flags
- [ ] Create `v1_7_0_async_hooks.py` migration
- [ ] Add unit tests for new hook configuration
- [ ] Add migration tests

### Phase 3: Integration
- [ ] Test new installations with async hooks
- [ ] Test migration from 1.6.x to 1.7.0
- [ ] Test rollback from 1.7.0 to 1.6.x
- [ ] Test with real Claude Code instance

### Phase 4: Documentation
- [ ] Update CHANGELOG.md with async hooks feature
- [ ] Document async vs sync hooks in user docs
- [ ] Update migration guide with async hooks example
- [ ] Update README with performance improvements

### Phase 5: Release
- [ ] Run pre-publish checks: `make pre-publish`
- [ ] Build release: `make safe-release-build`
- [ ] Create git tag: `git tag v1.7.0`
- [ ] Publish to PyPI: `make release-pypi`
- [ ] Create GitHub release

---

## 9. File Reference

### Key Files Investigated

| File Path | Purpose | Lines of Interest |
|-----------|---------|-------------------|
| `src/kuzu_memory/installers/claude_hooks.py` | Hook deployment and configuration | 29-41 (events), 481-544 (config) |
| `src/kuzu_memory/migrations/manager.py` | Migration orchestration | 79-303 (core logic) |
| `src/kuzu_memory/migrations/base.py` | Migration base classes | 40-283 (base classes) |
| `src/kuzu_memory/migrations/v1_7_0_bash_hooks.py` | Example migration | 15-165 (full implementation) |
| `src/kuzu_memory/migrations/__init__.py` | Migration discovery | 37-94 (auto-discovery) |
| `scripts/version.py` | Version management | 316-391 (CLI interface) |
| `VERSION` | Current version | 1 (1.6.32) |

### Hook Configuration Paths

**Primary:**
- `.claude/settings.local.json` (project-level)

**Also Checked:**
- `~/.claude/settings.json` (user-level)
- `~/.claude/settings.local.json` (user-level)
- `{project}/.claude/settings.json` (project-level)

---

## 10. Next Steps

### Immediate Actions
1. **Create async hooks migration** following v1_7_0_bash_hooks.py pattern
2. **Update hook configuration** to include async flags
3. **Write comprehensive tests** for both new installs and migrations
4. **Test with Claude Code** to verify async behavior works correctly

### Future Considerations
1. **Monitor performance** impact of async hooks
2. **Gather user feedback** on async behavior
3. **Consider making async configurable** per-hook in future versions
4. **Explore async enhancement** if Claude Code supports it in future

---

## Appendix A: Hook Event Decision Matrix

| Event | Should Be Async? | Rationale |
|-------|------------------|-----------|
| SessionStart | ✅ Yes | Initialization can happen in background, doesn't block first prompt |
| UserPromptSubmit | ❌ No | Must enhance prompt synchronously before Claude processes it |
| PostToolUse | ✅ Yes | Learning can happen asynchronously, doesn't need to block user |
| PreToolUse | ❓ Maybe | Depends on whether validation/enhancement is needed before tool execution |
| Stop | ✅ Yes | Cleanup/logging can happen in background |
| SubagentStop | ✅ Yes | Same as Stop |
| Notification | ✅ Yes | Notification handling can be async |
| SessionEnd | ✅ Yes | Cleanup can happen in background |
| PreCompact | ❓ Maybe | May need to complete before compaction starts |

---

## Appendix B: Migration Timing Strategy

### When Should Migration Run?

**Option 1: On kuzu-memory CLI startup (Current System)**
- Migrations run automatically when `MigrationManager` is initialized
- Transparent to user
- **Recommended approach**

**Option 2: Manual migration command**
- User runs: `kuzu-memory migrate`
- More control, but requires user action
- Good for troubleshooting

**Option 3: During hook execution**
- Migration happens on first hook execution
- Potential performance impact on first use
- Not recommended

**Recommendation:** Use Option 1 (automatic on startup) with Option 2 (manual command) as fallback.

---

## Conclusion

The Kuzu Memory hook system is well-architected with comprehensive migration infrastructure. Adding async hook support requires:

1. **Simple Code Change:** Add `"async": true` to SessionStart and PostToolUse hooks
2. **Migration Creation:** Follow v1_7_0_bash_hooks.py pattern
3. **Version Bump:** 1.6.32 → 1.7.0 (minor version for feature addition)
4. **Testing:** Verify new installs and migrations work correctly

**Estimated Effort:** 2-4 hours for implementation and testing

**Risk Level:** Low (well-defined infrastructure, clear patterns to follow)

**Recommendation:** Proceed with implementation using migration pattern established in v1.7.0_bash_hooks.py.
